<div class="dashboard-container">
  <!-- Header -->
  <app-header></app-header>

  <!-- Main Content -->
  <main class="dashboard-main" [class.has-child-route]="isChildRouteActive()">
    <!-- Router outlet for child routes (like coffee form) -->
    <router-outlet></router-outlet>
    <!-- Dashboard content (only shown when no child route is active) -->
    @if (!isChildRouteActive()) {
    <div class="dashboard-content">
      <!-- Welcome Section -->
      @if (!isLoading() && totalTastings() !== 0) {
      <section class="welcome-section">
        <h1 class="welcome-title">
          {{ 'welcomeMessage' | translate }}
          <span class="highlight">{{ userName() }}</span
          >!
        </h1>
        <p class="welcome-subtitle">{{ 'dashboardSubtitle' | translate }}</p>

        <button class="new-tasting-btn" (click)="onNewTasting()">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path
              d="M12 5v14M5 12h14"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          {{ 'newTastingButton' | translate }}
        </button>
      </section>
      }

      <!-- Loading State -->
      @if (isLoading()) {
      <div class="loading-container">
        <div class="spinner"></div>
        <p>{{ 'loadingMessage' | translate }}</p>
      </div>
      }

      <!-- Empty State - No tastings yet -->
      @if (!isLoading() && totalTastings() === 0) {
      <section class="empty-state">
        <div class="empty-state-content">
          <div class="empty-state-icon">
            <svg class="coffee-icon-large" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="6" y1="1" x2="6" y2="4" stroke-width="2" stroke-linecap="round"/>
              <line x1="10" y1="1" x2="10" y2="4" stroke-width="2" stroke-linecap="round"/>
              <line x1="14" y1="1" x2="14" y2="4" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <h2 class="empty-state-title">{{ 'emptyStateTitle' | translate }}</h2>
          <p class="empty-state-description">{{ 'emptyStateDescription' | translate }}</p>
          <button class="new-tasting-btn" (click)="onNewTasting()">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path
                d="M12 5v14M5 12h14"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            {{ 'newTastingButton' | translate }}
          </button>
        </div>
      </section>
      }

      <!-- Stats Grid - Only show when there are tastings -->
      @if (!isLoading() && totalTastings() > 0) {
      <app-stats-grid
        [totalTastings]="totalTastings()"
        [topOrigins]="topOrigins()"
        [favoriteBrewMethod]="favoriteBrewMethod()"
        [tastingTrend]="tastingTrend()"
        [insights]="insights()"
      ></app-stats-grid>
      }

      <!-- Recent Tastings - Only show when there are tastings -->
      @if (!isLoading() && totalTastings() > 0) {
      <section class="recent-tastings">
        <div class="section-header">
          <h2>{{ 'recentTastingsTitle' | translate }}</h2>

          <!-- Filtro de búsqueda y ordenamiento -->
          <div class="search-filter">
            <div class="search-input-wrapper">
              <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="11" cy="11" r="8" stroke-width="2" />
                <path d="m21 21-4.35-4.35" stroke-width="2" stroke-linecap="round" />
              </svg>
              <input
                type="text"
                class="search-input"
                [placeholder]="'searchPlaceholder' | translate"
                [value]="searchQuery()"
                (input)="onSearchChange($event)"
                (keyup)="onSearchChange($event)"
              />
              @if (searchQuery()) {
              <button
                class="clear-search-btn"
                (click)="clearSearch()"
                type="button"
                [title]="'clearSearchAriaLabel' | translate"
                [attr.aria-label]="'clearSearchAriaLabel' | translate"
                id="clear-search-button"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                >
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path
                    d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                  ></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
              }
            </div>

            <!-- Botones de ordenamiento -->
            <div class="sort-buttons">
              <button
                class="sort-btn"
                [class.active]="sortOrder() === 'best'"
                (click)="sortByBest()"
                [title]="'sortBestTooltip' | translate"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <polygon
                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                <span>{{ 'sortBestButton' | translate }}</span>
              </button>

              <button
                class="sort-btn"
                [class.active]="sortOrder() === 'worst'"
                (click)="sortByWorst()"
                [title]="'sortWorstTooltip' | translate"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path
                    d="M12 5v14"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M19 12l-7 7-7-7"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                <span>{{ 'sortWorstButton' | translate }}</span>
              </button>

              <button
                class="sort-btn"
                [class.active]="sortOrder() === 'recent'"
                (click)="sortByRecent()"
                [title]="'sortByRecentAriaLabel' | translate"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <circle cx="12" cy="12" r="10" stroke-width="2" />
                  <polyline
                    points="12 6 12 12 16 14"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                <span>{{ 'sortRecentButton' | translate }}</span>
              </button>
            </div>
          </div>
        </div>

        @if (isLoading()) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>{{ 'loadingMessage' | translate }}</p>
        </div>
        } @else if (errorMessage()) {
        <div class="error-state">
          <p>{{ errorMessage() }}</p>
          <button class="retry-btn" (click)="loadDashboardData()">
            {{ 'retryButton' | translate }}
          </button>
        </div>
        } @else if (filteredTastings().length > 0) {
        <div class="tastings-grid">
          @for (tasting of filteredTastings(); track tasting.coffeeName) {
          <app-tasting-card
            [tasting]="tasting"
            [tastingId]="getTastingId(tasting)"
            (cardClick)="onViewTasting($event)"
          ></app-tasting-card>
          }
        </div>
        } @else {
        <div class="empty-state">
          @if (searchQuery()) {
          <!-- Estado cuando no hay resultados de búsqueda -->
          <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="11" cy="11" r="8" stroke-width="2" />
            <path d="m21 21-4.35-4.35" stroke-width="2" stroke-linecap="round" />
            <line x1="11" y1="8" x2="11" y2="14" stroke-width="2" stroke-linecap="round" />
            <circle cx="11" cy="17" r="0.5" fill="currentColor" stroke="none" />
          </svg>
          <h3>{{ 'noResultsTitle' | translate }}</h3>
          <p>{{ 'noResultsMessage' | translate }}</p>
          <button class="cta-button secondary" (click)="clearSearch()">
            {{ 'clearSearchButton' | translate }}
          </button>
          } @else {
          <!-- Estado cuando no hay resultados de búsqueda pero sí hay catas -->
          <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="11" cy="11" r="8" stroke-width="2" />
            <path d="m21 21-4.35-4.35" stroke-width="2" stroke-linecap="round" />
            <line x1="11" y1="8" x2="11" y2="14" stroke-width="2" stroke-linecap="round" />
            <circle cx="11" cy="17" r="0.5" fill="currentColor" stroke="none" />
          </svg>
          <h3>{{ 'noResultsTitle' | translate }}</h3>
          <p>{{ 'noResultsMessage' | translate }}</p>
          <button class="cta-button secondary" (click)="clearSearch()">
            {{ 'clearSearchButton' | translate }}
          </button>
          }
        </div>
        }
      </section>
      }
    </div>
    <!-- End dashboard-content -->
    }
  </main>

  <!-- Insight Toast - Show when there are insights
  @if (!isLoading() && insights().length > 0) {
    <app-insight-toast [insights]="insights()"></app-insight-toast>
  }
  -->

  <!-- Popup -->
  @if (showPopup && selectedTasting) {
    <app-tasting-detail-popup 
      [tasting]="selectedTasting"
      (close)="onClosePopup()">
    </app-tasting-detail-popup>
  }
</div>
